import React, { useEffect, useRef, forwardRef, useImperativeHandle } from "react";

/**
 * 64x64 / 3等身 / パーツ差し替え前提の「標準」レンダラー
 * - すべてのパーツは固定キャンバス（部位ごと）を持つ
 * - 貼り付け位置はアンカーで固定（ズレない）
 * - 両目など左右は「片側定義→ミラー」で100%保証
 */
const SpriteRenderer64 = forwardRef(
  (
    {
      charState = {},
      bgColor = "transparent",
      scale = 6,
      className = "",
    },
    ref
  ) => {
    const canvasRef = useRef(null);
    useImperativeHandle(ref, () => canvasRef.current);

    // ======= 基本設定 =======
    const CANVAS_SIZE = 64;
    const OFFSET_X = 0;
    const OFFSET_Y = 0;

    // 64x64 の座標系
    const CENTER_X = 32;
    const GROUND_Y = 60; // 足裏ライン（基準）

    // ======= 固定アンカー（まずは標準を固定） =======
    const ANCHORS = {
      head: { x: 20, y: 6 },     // 32x32相当の頭領域を想定
      face: { x: 22, y: 10 },    // 顔（輪郭）
      eyes: { x: 32, y: 22 },    // 左右目ペアの中心
      torso: { x: 24, y: 28 },   // 胴の左上
      pelvis:{ x: 24, y: 40 },   // 腰の左上
      legs: { x: 24, y: 46 },    // 脚の左上
      handL:{ x: 18, y: 34 },    // 左手装備基準
      handR:{ x: 46, y: 34 },    // 右手装備基準
      weapon:{ x: 50, y: 36 },   // 武器の握り基準（右側）
    };

    // 左右ミラー（64幅）
    const mirrorX = (x) => (CANVAS_SIZE - 1 - x);

    useEffect(() => {
      const canvas = canvasRef.current;
      if (!canvas) return;

      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = false;

      // クリア
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

      if (bgColor !== "transparent") {
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
      }

      // ======= レイヤーバッファ（重なり順を固定） =======
      const createBuffer = () => {
        const c = document.createElement("canvas");
        c.width = CANVAS_SIZE;
        c.height = CANVAS_SIZE;
        const cctx = c.getContext("2d");
        cctx.imageSmoothingEnabled = false;
        return { c, cctx };
      };

      const LAYERS = {
        LowerBody: 0,
        TorsoBase: 1,
        UpperBody_Back: 2,
        HeadBase: 3,
        Ears_Back: 4,
        Hair_Back: 5,
        EyesBrow: 6,
        Nose: 7,
        Mouth: 8,
        Hair_Front: 9,
        Ears_Front: 10,
        UpperBody_Front: 11,
        Weapon: 12,
        FX: 13,
      };

      const buffers = Array.from({ length: 14 }, createBuffer);
      const ctxs = buffers.map((b) => b.cctx);

      let currentLayer = LAYERS.TorsoBase;
      const setLayer = (idx) => (currentLayer = idx);

      const drawPixel = (x, y, color) => {
        if (!color || color === "transparent") return;
        const c = ctxs[currentLayer];
        c.fillStyle = color;
        c.fillRect(x + OFFSET_X, y + OFFSET_Y, 1, 1);
      };

      // ======= パレット（色） =======
      const skin = charState.skinColor ?? "#ffdbac";
      const hair = charState.hairColor ?? "#2c2c2c";
      const eye  = charState.eyeColor  ?? "#2c3e50";
      const outfitTop = charState.outfitTopColor ?? "#3b82f6";
      const outfitBottom = charState.outfitBottomColor ?? "#1f2937";
      const shoe = charState.shoeColor ?? "#111827";

      // ちょい影・ハイライト（標準の簡易ランプ）
      const shade = (hex, amt) => {
        // 超簡易：#rrggbb のみ対応
        const h = (hex || "").replace("#", "");
        if (h.length !== 6) return hex;
        const r = Math.max(0, Math.min(255, parseInt(h.slice(0,2),16) + amt));
        const g = Math.max(0, Math.min(255, parseInt(h.slice(2,4),16) + amt));
        const b = Math.max(0, Math.min(255, parseInt(h.slice(4,6),16) + amt));
        const to2 = (n) => n.toString(16).padStart(2, "0");
        return `#${to2(r)}${to2(g)}${to2(b)}`;
      };

      const pal = {
        // Face
        F: skin,
        f: shade(skin, -18),
        h: shade(skin, +18),

        // Hair
        H: hair,
        d: shade(hair, -26),
        l: shade(hair, +20),

        // Eyes
        S: "#ffffff",
        s: "#e6e6e6",
        I: eye,
        i: shade(eye, -35),
        p: "#000000",
        w: "#ffffff", // spec

        // Outfit
        T: outfitTop,
        t: shade(outfitTop, -24),
        B: outfitBottom,
        b: shade(outfitBottom, -24),
        O: shoe,
      };

      // ======= パーツアセット（標準） =======
      // ルール：
      // - '.' は透明
      // - 文字は pal に解決
      // - flipX を使って左右対称を保証（右目/右耳/右腕など）
      const PART_ASSETS = {
        // 顔（24x24）
        face_normal: {
          w: 24, h: 24,
          px: [
            "....FFFFFFFFFFFFFFFF....",
            "...FFFFFFFFFFFFFFFFFF...",
            "..FFFFFFFFFFFFFFFFFFFF..",
            ".FFFFFFFFFFFFFFFFFFFFFF.",
            ".FFFFFFFFFFFFFFFFFFFFFF.",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            "FFFFFFFFFFFFFFFFFFFFFFFF",
            ".FFFFFFFFFFFFFFFFFFFFFF.",
            ".FFFFFFFFFFFFFFFFFFFFFF.",
            "..FFFFFFFFFFFFFFFFFFFF..",
            "...FFFFFFFFFFFFFFFFFF...",
            "....FFFFFFFFFFFFFFFF....",
            "........................",
          ],
        },

        // 耳（左右セット 28x16） ※標準は控えめ
        ears_normal: {
          w: 28, h: 16,
          px: [
            "............................",
            "....FF................FF....",
            "...FFF................FFF...",
            "...FFF................FFF...",
            "...FFF................FFF...",
            "....FF................FF....",
            "............................",
            "............................",
            "............................",
            "............................",
            "............................",
            "............................",
            "............................",
            "............................",
            "............................",
            "............................",
          ],
        },

        // 目＋眉（24x12）左右ペアを1枚に固定して「合体事故」を防ぐ
        eyes_normal: {
          w: 24, h: 12,
          px: [
            "........................",
            "....ddd......ddd.......", // 眉（髪の暗色で表現）
            "........................",
            "...SSS......SSS........",
            "...SIS......SIS........",
            "...Ssp......Ssp........",
            "........................",
            "....w........w.........", // ハイライト位置（左右で同じ見え）
            "........................",
            "........................",
            "........................",
            "........................",
          ],
        },

        // 鼻（8x6）
        nose_normal: {
          w: 8, h: 6,
          px: [
            "........",
            "...f....",
            "..ff....",
            "...f....",
            "........",
            "........",
          ],
        },

        // 口（12x8）
        mouth_normal: {
          w: 12, h: 8,
          px: [
            "............",
            "............",
            "...ffffff...",
            "..f....f....",
            "...ffffff...",
            "............",
            "............",
            "............",
          ],
        },

        // 髪（32x32）※標準：前髪＋外形だけ
        hair_back: {
          w: 32, h: 32,
          px: [
            "........HHHHHHHHHHHHHH........",
            "......HHHHHHHHHHHHHHHHHH......",
            ".....HHHHHHHHHHHHHHHHHHHH.....",
            "....HHHHHHHHHHHHHHHHHHHHHH....",
            "...HHHHHHHHHHHHHHHHHHHHHHHH...",
            "..HHHHHHHHHHHHHHHHHHHHHHHHHH..",
            "..HHHHHHHHHHHHHHHHHHHHHHHHHH..",
            "..HHHHHHHHHHHHHHHHHHHHHHHHHH..",
            "..HHHHHHHHHHHHHHHHHHHHHHHHHH..",
            "...HHHHHHHHHHHHHHHHHHHHHHHH...",
            "....HHHHHHHHHHHHHHHHHHHHHH....",
            ".....HHHHHHHHHHHHHHHHHHHH.....",
            "......HHHHHHHHHHHHHHHHHH......",
            ".......HHHHHHHHHHHHHHH........",
            "........HHHHHHHHHHHH..........",
            "..........HHHHHHHH............",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
          ],
        },
        hair_front: {
          w: 32, h: 32,
          px: [
            "..............................",
            "..............................",
            "...........HHHHHH.............",
            "..........HHHHHHHH............",
            ".........HHHHHHHHHH...........",
            "........HHHHHHHHHHHH..........",
            "........HHHH..HHHHHH..........",
            "........HHH....HHHHH..........",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
            "..............................",
          ],
        },

        // 上半身（40x24）
        upper_normal: {
          w: 40, h: 24,
          px: [
            "........................................",
            "........................................",
            "...........TTTTTTTTTTTTTT...............",
            "..........TTTTTTTTTTTTTTTT..............",
            ".........TTTTTTTTTTTTTTTTTT.............",
            "........TTTTTTTTTTTTTTTTTTTT............",
            "........TTTTTTTTTTTTTTTTTTTT............",
            "........TTTTTTTTTTTTTTTTTTTT............",
            ".........TTTTTTTTTTTTTTTTTT.............",
            "..........TTTTTTTTTTTTTTTT..............",
            "...........TTTTTTTTTTTTTT...............",
            "............tttttttttttt................",
            "........................................",
            "....FF..........................FF......", // 手（肌）
            "...FFF........................FFF.......",
            "...FFF........................FFF.......",
            "....FF........................FF........",
            "........................................",
            "........................................",
            "........................................",
            "........................................",
            "........................................",
            "........................................",
            "........................................",
          ],
        },

        // 下半身（32x24）
        lower_normal: {
          w: 32, h: 24,
          px: [
            "................................",
            ".............BBBBBB.............",
            "............BBBBBBBB............",
            "...........BBBBBBBBBB...........",
            "...........BBBBBBBBBB...........",
            "...........BBBBBBBBBB...........",
            "...........BBBBBBBBBB...........",
            "...........BBBBBBBBBB...........",
            "...........BBBB..BBBB...........",
            "...........BBBB..BBBB...........",
            "...........BBBB..BBBB...........",
            "...........BBBB..BBBB...........",
            "...........BBBB..BBBB...........",
            "...........BBBB..BBBB...........",
            "...........BBBB..BBBB...........",
            "...........BBBB..BBBB...........",
            "...........OOOO..OOOO...........",
            "...........OOOO..OOOO...........",
            "...........OOOO..OOOO...........",
            "................................",
            "................................",
            "................................",
            "................................",
            "................................",
          ],
        },

        // 武器（32x32）※標準は無し（空）
        weapon_none: { w: 1, h: 1, px: ["." ] },
      };

      const drawPart = (asset, x, y, { flipX = false, palette = pal } = {}) => {
        if (!asset || !asset.px) return;
        const w = asset.w | 0;
        const h = asset.h | 0;

        for (let ay = 0; ay < h; ay++) {
          const row = asset.px[ay] || "";
          for (let ax = 0; ax < w; ax++) {
            const sx = flipX ? (w - 1 - ax) : ax;
            const ch = row[sx] || ".";
            if (ch === ".") continue;
            const col = palette[ch];
            if (!col || col === "transparent") continue;
            drawPixel(x + ax, y + ay, col);
          }
        }
      };

      // ======= 合成（標準キャラ） =======
      // 下半身
      setLayer(LAYERS.LowerBody);
      drawPart(PART_ASSETS.lower_normal, ANCHORS.legs.x, ANCHORS.pelvis.y);

      // 上半身（胴＋手）
      setLayer(LAYERS.TorsoBase);
      drawPart(PART_ASSETS.upper_normal, 12, ANCHORS.torso.y);

      // 頭（顔）
      setLayer(LAYERS.HeadBase);
      drawPart(PART_ASSETS.face_normal, ANCHORS.face.x, ANCHORS.face.y);

      // 耳（必要なら髪より後ろ）
      setLayer(LAYERS.Ears_Back);
      drawPart(PART_ASSETS.ears_normal, 18, 12);

      // 髪（後）
      setLayer(LAYERS.Hair_Back);
      drawPart(PART_ASSETS.hair_back, ANCHORS.head.x, ANCHORS.head.y);

      // 目＋眉（1枚で固定：左右合体を根絶）
      setLayer(LAYERS.EyesBrow);
      // eyes_normal は 24x12 を (22,18) に貼る想定（さっき決めた仕様）
      drawPart(PART_ASSETS.eyes_normal, 22, 18);

      // 鼻
      setLayer(LAYERS.Nose);
      drawPart(PART_ASSETS.nose_normal, 30, 26);

      // 口
      setLayer(LAYERS.Mouth);
      drawPart(PART_ASSETS.mouth_normal, 26, 30);

      // 髪（前）
      setLayer(LAYERS.Hair_Front);
      drawPart(PART_ASSETS.hair_front, ANCHORS.head.x, ANCHORS.head.y);

      // 武器（標準は無し）
      setLayer(LAYERS.Weapon);
      drawPart(PART_ASSETS.weapon_none, ANCHORS.weapon.x, ANCHORS.weapon.y);

      // ======= 最終合成：レイヤー順にメインへ =======
      for (let i = 0; i < buffers.length; i++) {
        ctx.drawImage(buffers[i].c, 0, 0);
      }
    }, [charState, bgColor]);

    return (
      <canvas
        ref={canvasRef}
        width={64}
        height={64}
        style={{
          width: 64 * scale,
          height: 64 * scale,
          imageRendering: "pixelated",
          display: "block",
        }}
        className={className}
      />
    );
  }
);

export default SpriteRenderer64;